<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniCorp CEO: Succession Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Global Image Error Handler -->
    <script>
        window.handleImageError = function(img) {
            const name = img.getAttribute('data-name') || 'fallback';
            img.onerror = null; 
            // Fallback to Robohash Set 1 (Robots) if primary fails
            img.src = `https://robohash.org/${name}.png?set=set1&size=300x300`;
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 1s ease, transform 1s ease; }
        
        .footer-branding {
            position: fixed;
            bottom: 10px;
            right: 20px;
            font-size: 0.70rem;
            color: #94a3b8;
            font-weight: 700;
            pointer-events: none;
            z-index: 50;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.6;
        }

        @keyframes countdown {
            from { width: 100%; background-color: #22c55e; }
            60% { background-color: #eab308; }
            to { width: 0%; background-color: #ef4444; }
        }
        .timer-animate {
            animation: countdown 100s linear forwards;
        }

        .choice-btn:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .card-carousel {
            display: flex;
            gap: 2rem;
            padding: 2rem 4rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            height: 100%;
            align-items: center;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .card-carousel::-webkit-scrollbar { 
            display: none; 
        }
        
        .scenario-card {
            min-width: 320px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center center;
            opacity: 0.9;
            filter: grayscale(10%);
        }
        
        .scenario-card:hover {
            transform: scale(1.1) translateY(-10px);
            z-index: 10;
            opacity: 1;
            filter: grayscale(0%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .scenario-card.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.05);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col text-slate-800">

    <div class="footer-branding">
        Strategic Simulation - Aalto 2025 By NILESH KUMAR
    </div>

    <!-- 1. API KEY SCREEN -->
    <div id="apiKeyModal" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 transition-opacity duration-500">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 to-indigo-700"></div>
            <h2 class="text-3xl font-extrabold text-slate-900 mb-2">OmniCorp CEO</h2>
            <p class="text-slate-500 mb-8 font-medium">Succession Edition v7.0</p>
            
            <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 mb-6 text-left">
                <p class="text-xs text-slate-500 font-bold uppercase mb-2 tracking-wider">Directives:</p>
                <ul class="text-sm text-slate-600 space-y-2 list-disc pl-4">
                    <li>Select 5 strategic challenges.</li>
                    <li><strong>4 Choices</strong>: One correct, one trap.</li>
                    <li><strong>100 Seconds</strong> per decision.</li>
                </ul>
            </div>

            <input type="password" id="apiKeyInput" placeholder="Enter Gemini API Key" class="w-full p-4 border border-slate-300 rounded-xl mb-4 focus:ring-2 focus:ring-blue-600 outline-none transition font-mono text-sm">
            <button onclick="saveApiKey()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2 group">
                <span>Enter Boardroom</span>
                <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- 2. SELECTION SCREEN -->
    <div id="selectionScreen" class="hidden flex-1 flex flex-col w-full h-full overflow-hidden relative bg-slate-50">
        <header class="pt-8 pb-4 text-center z-10 relative">
            <h1 class="text-3xl font-extrabold text-slate-900">Select Your Agenda</h1>
            <p class="text-slate-500 mt-2">Choose <span class="font-bold text-blue-600">5 strategic topics</span>. Move mouse to scroll.</p>
        </header>

        <div class="flex-1 w-full relative overflow-hidden" id="carouselWrapper">
            <div class="card-carousel" id="cardsGrid"></div>
            <div class="absolute top-0 left-0 w-12 h-full bg-gradient-to-r from-slate-50 to-transparent pointer-events-none z-20"></div>
            <div class="absolute top-0 right-0 w-12 h-full bg-gradient-to-l from-slate-50 to-transparent pointer-events-none z-20"></div>
        </div>

        <div class="bg-white/90 backdrop-blur-md border-t border-slate-200 p-6 shadow-2xl z-40">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <span class="text-slate-400 text-sm font-bold uppercase tracking-widest">Agenda Items</span>
                    <span class="text-3xl font-bold text-slate-800"><span id="selectionCount" class="text-blue-600">0</span>/5</span>
                </div>
                <button id="startSimulationBtn" onclick="startSimulation()" disabled class="bg-slate-200 text-slate-400 font-bold py-4 px-10 rounded-xl transition cursor-not-allowed text-lg shadow-sm">
                    Start Simulation
                </button>
            </div>
        </div>
    </div>

    <!-- 3. GAMEPLAY -->
    <div class="hidden flex-1 flex-col lg:flex-row w-full h-full max-w-7xl mx-auto p-4 lg:p-8 gap-6" id="gameContainer">
        
        <!-- LEFT: Character -->
        <div class="lg:w-1/3 flex flex-col h-full relative fade-enter-active" id="characterColumn">
            <div class="w-full h-2 bg-slate-200 rounded-full mb-4 overflow-hidden">
                <div id="timerBar" class="h-full w-full bg-green-500"></div>
            </div>

            <div class="flex-1 glass-panel rounded-2xl relative overflow-hidden flex flex-col items-center justify-end bg-gradient-to-t from-slate-200 to-slate-50 border-slate-200">
                <img id="characterImage" src="" 
                     data-name=""
                     onerror="window.handleImageError(this)" 
                     alt="Executive" 
                     class="w-auto h-[70%] object-contain drop-shadow-2xl z-10 transition-transform duration-1000 ease-out translate-y-10 opacity-0">
                
                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur px-6 py-3 rounded-xl border border-slate-200 shadow-lg z-20 text-center min-w-[200px]">
                    <p class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-1" id="characterRole">ROLE</p>
                    <p class="text-lg font-extrabold text-slate-900 leading-none" id="characterName">Name</p>
                </div>
            </div>
        </div>

        <!-- RIGHT: Interaction -->
        <div class="lg:w-2/3 flex flex-col gap-6 h-full relative" id="contentColumn">
            
            <div class="glass-panel rounded-2xl p-8 flex flex-col gap-4 relative overflow-hidden min-h-[280px] justify-center text-center fade-enter-active" id="questionPanel">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <div class="absolute top-4 right-6 flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full">
                    <i class="fas fa-chart-line text-blue-600 text-xs"></i>
                    <span class="text-xs font-bold text-slate-600">IQ: <span id="iqText">100%</span></span>
                </div>
                <div class="absolute top-4 left-6 text-xs font-bold text-slate-400 uppercase tracking-widest">
                    Scenario <span id="levelIndicator">1</span>/5
                </div>

                <div class="mt-4 transition-opacity duration-700" id="questionTextContainer">
                    <h2 class="text-2xl lg:text-3xl font-extrabold text-slate-800 leading-tight mb-4" id="scenarioTitle">Title</h2>
                    <p class="text-lg text-slate-600 leading-relaxed max-w-3xl mx-auto" id="scenarioText">Loading scenario...</p>
                </div>

                <div class="mt-6 bg-blue-50/50 border border-blue-100 rounded-lg p-3 inline-block mx-auto max-w-2xl">
                    <p class="text-xs text-blue-800 font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-lightbulb text-blue-500"></i>
                        <span id="hintText">Hint...</span>
                    </p>
                </div>
            </div>

            <div class="flex-1 flex flex-col justify-end gap-4" id="answersPanel">
                <div id="loadingOverlay" class="hidden h-full flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-blue-600"></i>
                    <p class="text-sm font-bold uppercase tracking-widest">Board is deliberating...</p>
                </div>

                <div id="choicesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 transition-opacity duration-500"></div>
            </div>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        let apiKey = "", selectedIndices = [], currentPlayIndex = 0, totalScore = 0, timerInterval, activeScenario = null;
        const TIME_LIMIT = 100;
        // USING BOTTTS (Robots/Aliens) for abstract style as requested to solve visual issues
        const avatarBase = "https://api.dicebear.com/7.x/bottts/svg";

        const topics = [
            {
                id: 1, title: "Corporate Scope", role: "VP Marketing", name: "Shiv Roy", 
                avatarParams: "?seed=ShivRoy",
                variations: [
                    { text: "We found 'Urban Kicks', a cool sneaker brand. It makes us look modern. What is your first question?", hint: "Remember 'Parenting Advantage' - why us?", options: [{ text: "Why should WE own this? What value do we add?", score: 10 }, { text: "Is this brand strategically aligned with our future image?", score: 7 }, { text: "Is the company currently profitable?", score: 3 }, { text: "Will this help us reach Gen Z customers?", score: 0 }] },
                    { text: "Our rival bought a software firm. We need to buy one too. Should we bid?", hint: "Don't buy just to match rivals.", options: [{ text: "Only if our corporate structure adds unique value to their code.", score: 10 }, { text: "Yes, we cannot fall behind in the digital race.", score: 3 }, { text: "Check if their culture fits ours first.", score: 7 }, { text: "What is the price relative to earnings?", score: 3 }] }
                ], principle: "Parenting Advantage"
            },
            {
                id: 2, title: "Frameworks", role: "Strategy Director", name: "Frank Vernon", 
                avatarParams: "?seed=FrankVernon",
                variations: [
                    { text: "I prepared a 50-page SWOT on Green Energy laws. Do you accept it?", hint: "Is SWOT the right tool for macro-shifts?", options: [{ text: "No. Give me a PESTEL or Scenario analysis.", score: 10 }, { text: "Yes, but summarize key Opportunities.", score: 3 }, { text: "Use the SWOT, focus on Threats.", score: 7 }, { text: "Great work, present to Board.", score: 0 }] },
                    { text: "We need to analyze industry structure. I suggest VRIO.", hint: "VRIO is internal. Industry needs external tool.", options: [{ text: "No. Use Porter's Five Forces for industry structure.", score: 10 }, { text: "VRIO is good, add a SWOT.", score: 3 }, { text: "Yes, VRIO tells if we are competitive.", score: 0 }, { text: "Use PESTEL instead.", score: 7 }] }
                ], principle: "Don't Worship Frameworks"
            },
            {
                id: 3, title: "Business vs Corp", role: "Head of Batteries", name: "Kendall Roy", 
                avatarParams: "?seed=KendallRoy",
                variations: [
                    { text: "We are #1 in batteries. Let's buy a Solar Panel factory. Approve?", hint: "Business Strategy vs Corporate Strategy.", options: [{ text: "No. Winning in batteries doesn't justify solar expansion.", score: 10 }, { text: "Yes, brand it correctly, dominate energy.", score: 3 }, { text: "Only if we use current factories.", score: 7 }, { text: "Approved. Vertical integration.", score: 0 }] },
                    { text: "Software unit is winning. Let's make hardware chips too!", hint: "Winning at X doesn't mean do Y.", options: [{ text: "Stop. Software success doesn't give us a right to hardware.", score: 10 }, { text: "Analyze chip market size.", score: 3 }, { text: "Good idea, copy Tesla.", score: 0 }, { text: "Only if hardware improves software.", score: 7 }] }
                ], principle: "Separate Biz vs Corp Strategy"
            },
            {
                id: 4, title: "Alliances", role: "M&A Consultant", name: "Roman Roy", 
                avatarParams: "?seed=RomanRoy",
                variations: [
                    { text: "Rival has tech we need. They want a full merger. Counter-proposal?", hint: "Mergers destroy identity. Alliances need exits.", options: [{ text: "Propose Alliance, mandate Exit Plan.", score: 10 }, { text: "Joint Venture, no end date.", score: 3 }, { text: "Hostile takeover.", score: 0 }, { text: "Merger, but keep brands separate.", score: 7 }] },
                    { text: "Partner wants cross-shareholding alliance. Sign?", hint: "Entry is easy. Exit is hard.", options: [{ text: "Only if we define 'Divorce Clauses' today.", score: 10 }, { text: "Yes, aligns interests perfectly.", score: 7 }, { text: "No, buy them out.", score: 0 }, { text: "Sign, keep teams separate.", score: 3 }] }
                ], principle: "Alliances & Exit Logic"
            },
            {
                id: 5, title: "Synergies", role: "CFO", name: "Gerri Kellman", 
                avatarParams: "?seed=GerriKellman",
                variations: [
                    { text: "I predict $50M savings by combining Sales teams. It happens naturally.", hint: "Synergies are earned, not assumed.", options: [{ text: "Reject. Show structural design for synergy.", score: 10 }, { text: "Aim for $60M.", score: 0 }, { text: "Approve, appoint Synergy Manager.", score: 7 }, { text: "Proceed, track monthly.", score: 3 }] },
                    { text: "Merging R&D. Synergy value is 'huge'. Sign here.", hint: "Vague promises are dangerous.", options: [{ text: "Where is value coming from? What structure?", score: 10 }, { text: "Need dollar number.", score: 3 }, { text: "Ensure heads meet weekly.", score: 7 }, { text: "Synergy is a myth.", score: 0 }] }
                ], principle: "Synergies are Earned"
            },
            {
                id: 6, title: "Structure & Culture", role: "HR Director", name: "Karolina Novotney", 
                avatarParams: "?seed=KarolinaNovotney",
                variations: [
                    { text: "Divisions fighting. Redraw Org Chart to fix culture?", hint: "Structure & Culture & Leadership.", options: [{ text: "No. Charts don't fix culture. Need shared norms.", score: 10 }, { text: "Yes, clearer lines solve conflict.", score: 0 }, { text: "Fire troublemakers.", score: 3 }, { text: "Redraw chart + weekly alignment meeting.", score: 7 }] },
                    { text: "Need innovation. Flatten hierarchy?", hint: "Structure is one leg of the stool.", options: [{ text: "Flattening helps, but need innovation culture/metrics.", score: 10 }, { text: "Yes, remove middle managers.", score: 3 }, { text: "Create Innovation Dept.", score: 0 }, { text: "Flatten layers + increase pay.", score: 7 }] }
                ], principle: "Structure vs Culture"
            },
            {
                id: 7, title: "Global Strategy", role: "VP Sales", name: "Tom Wambsgans", 
                avatarParams: "?seed=TomWambsgans",
                variations: [
                    { text: "Enter 20 new countries for 100% coverage!", hint: "Roles (Hub, Option), not flags.", options: [{ text: "Stop. Assign specific 'Role' to each market.", score: 10 }, { text: "Go for it, growth!", score: 0 }, { text: "Enter top 5 profitable first.", score: 7 }, { text: "10 now, 10 later.", score: 3 }] },
                    { text: "Losing money in Brazil. Exit?", hint: "Profit Pool vs Option?", options: [{ text: "Depends. Is it a future 'Option' or failed 'Profit Pool'?", score: 10 }, { text: "Yes, cut losers.", score: 3 }, { text: "No, need global footprint.", score: 0 }, { text: "Keep if covering variable costs.", score: 7 }] }
                ], principle: "Global Roles"
            },
            {
                id: 8, title: "Capital Allocation", role: "Legacy Head", name: "Connor Roy", 
                avatarParams: "?seed=ConnorRoy",
                variations: [
                    { text: "My division is shrinking. Give me capital to defend share!", hint: "Fix, Sell, or Close.", options: [{ text: "No. Capital to growth engines, not shrinking moats.", score: 10 }, { text: "Okay, can't abandon our core legacy.", score: 0 }, { text: "Half of what you asked.", score: 7 }, { text: "Submit turnaround plan.", score: 3 }] },
                    { text: "Moonshot unit needs cash, Core demands upgrades.", hint: "Three Horizons.", options: [{ text: "Fund Core health, but protect Moonshot budget.", score: 10 }, { text: "Give all to Moonshot.", score: 0 }, { text: "Feed Core first.", score: 3 }, { text: "Split 50/50.", score: 7 }] }
                ], principle: "Capital Allocation"
            },
            {
                id: 9, title: "Governance", role: "Secretary", name: "Greg Hirsch", 
                avatarParams: "?seed=GregHirsch",
                variations: [
                    { text: "Open seat. Friend Bob (agrees) or Sarah (critiques)?", hint: "Governance requires challenge.", options: [{ text: "Sarah. I need constructive challenge.", score: 10 }, { text: "Bob. Need unity.", score: 3 }, { text: "Neither, celebrity.", score: 0 }, { text: "Sarah, if she's polite.", score: 7 }] },
                    { text: "Board wants monthly strategy reviews. Distracting!", hint: "Board is guardian of value.", options: [{ text: "Accept. Board guards long-term value.", score: 10 }, { text: "Tell them to back off.", score: 0 }, { text: "Compromise quarterly.", score: 7 }, { text: "Send reports, cancel meetings.", score: 3 }] }
                ], principle: "Governance"
            },
            {
                id: 10, title: "Uncertainty", role: "Chairman", name: "Logan Roy", 
                avatarParams: "?seed=LoganRoy",
                variations: [
                    { text: "Mega-factory for unproven product. 40% cash. Build?", hint: "Options & Reversibility.", options: [{ text: "No. Run pilot experiment first.", score: 10 }, { text: "Fortune favors bold.", score: 0 }, { text: "Build, cut costs.", score: 3 }, { text: "Build medium factory.", score: 7 }] },
                    { text: "Market volatile. Can't forecast. What do?", hint: "Think in options.", options: [{ text: "Stop forecasting. Invest in portfolio of Options.", score: 10 }, { text: "Hire better consultants.", score: 0 }, { text: "Hoard cash.", score: 3 }, { text: "Bet on most likely scenario.", score: 7 }] }
                ], principle: "Options & Reversibility"
            }
        ];

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('key')) {
                apiKey = urlParams.get('key');
                document.getElementById('apiKeyModal').classList.add('hidden');
                document.getElementById('selectionScreen').classList.remove('hidden');
                renderSelectionCards();
                initAutoScroll();
            }
        };

        function saveApiKey() {
            const val = document.getElementById('apiKeyInput').value;
            if(val.length > 0) {
                apiKey = val;
                document.getElementById('apiKeyModal').classList.add('hidden');
                document.getElementById('selectionScreen').classList.remove('hidden');
                renderSelectionCards();
                initAutoScroll();
            } else {
                alert("Please enter a key.");
            }
        }

        function initAutoScroll() {
            const wrapper = document.getElementById('carouselWrapper');
            const carousel = document.getElementById('cardsGrid');
            wrapper.addEventListener('mousemove', (e) => {
                const width = wrapper.clientWidth;
                const x = e.clientX;
                const center = width / 2;
                const dist = (x - center) / center;
                if (Math.abs(dist) > 0.2) carousel.scrollLeft += dist * 25;
            });
        }

        function renderSelectionCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            topics.forEach((topic, idx) => {
                const card = document.createElement('div');
                card.className = "scenario-card bg-white p-5 rounded-xl border border-slate-200 cursor-pointer flex-shrink-0 flex flex-col gap-4 group h-80 w-72 justify-between";
                card.onclick = () => toggleSelection(idx, card);
                
                let avatarUrl = `${avatarBase}${topic.avatarParams}`;
                card.innerHTML = `
                    <div class="h-40 bg-slate-50 rounded-lg overflow-hidden flex items-end justify-center relative border border-slate-100">
                        <img src="${avatarUrl}" 
                             data-name="${topic.name}" 
                             onerror="window.handleImageError(this)" 
                             class="h-[100%] w-auto object-contain translate-y-2 group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg group-hover:text-blue-600 transition-colors">${topic.title}</h3>
                        <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider mt-1">${topic.role} (${topic.name})</p>
                    </div>
                    <div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-600 w-0 transition-all duration-300 select-bar"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleSelection(idx, el) {
            const bar = el.querySelector('.select-bar');
            if (selectedIndices.includes(idx)) {
                selectedIndices = selectedIndices.filter(i => i !== idx);
                el.classList.remove('selected');
                bar.style.width = '0%';
            } else {
                if (selectedIndices.length < 5) {
                    selectedIndices.push(idx);
                    el.classList.add('selected');
                    bar.style.width = '100%';
                }
            }
            document.getElementById('selectionCount').innerText = selectedIndices.length;
            const btn = document.getElementById('startSimulationBtn');
            if (selectedIndices.length === 5) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-blue-500/50', 'shadow-lg');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-blue-500/50', 'shadow-lg');
            }
        }

        function startSimulation() {
            document.getElementById('selectionScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('selectionScreen').classList.add('hidden');
                const gameContainer = document.getElementById('gameContainer');
                gameContainer.classList.remove('hidden');
                gameContainer.classList.add('flex');
                gameContainer.style.opacity = '0';
                setTimeout(() => { 
                    gameContainer.style.transition = 'opacity 1s';
                    gameContainer.style.opacity = '1';
                    startRound();
                }, 100);
            }, 1000);
        }

        function startRound() {
            const idx = selectedIndices[currentPlayIndex];
            const topic = topics[idx];
            activeScenario = topic.variations[Math.floor(Math.random() * topic.variations.length)];

            const charImg = document.getElementById('characterImage');
            const qPanel = document.getElementById('questionPanel');
            const cContainer = document.getElementById('choicesContainer');
            const qTextContainer = document.getElementById('questionTextContainer');

            charImg.style.opacity = '0'; qPanel.style.opacity = '0'; cContainer.style.opacity = '0';

            setTimeout(() => {
                let avatarUrl = `${avatarBase}${topic.avatarParams}`;
                charImg.setAttribute('data-name', topic.name);
                charImg.src = avatarUrl;
                
                document.getElementById('characterRole').innerText = topic.role;
                document.getElementById('characterName').innerText = topic.name;
                document.getElementById('scenarioTitle').innerText = topic.title;
                document.getElementById('scenarioText').innerText = activeScenario.text;
                document.getElementById('hintText').innerText = activeScenario.hint;
                document.getElementById('levelIndicator').innerText = currentPlayIndex + 1;
                qTextContainer.style.opacity = '1';

                cContainer.innerHTML = '';
                const shuffled = [...activeScenario.options].sort(() => Math.random() - 0.5);
                shuffled.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "choice-btn w-full bg-white border border-slate-200 p-5 rounded-xl text-left hover:bg-slate-50 transition-all group flex items-center justify-between";
                    btn.onclick = () => makeChoice(opt, btn);
                    btn.innerHTML = `<span class="font-semibold text-slate-700 group-hover:text-blue-700 transition-colors text-sm md:text-base leading-snug">${opt.text}</span><i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition-colors ml-4 flex-shrink-0"></i>`;
                    cContainer.appendChild(btn);
                });

                setTimeout(() => { charImg.style.opacity = '1'; }, 200);
                qPanel.style.opacity = '1';
                setTimeout(() => { cContainer.style.opacity = '1'; }, 300);
                startTimer();
            }, 800);
        }

        function startTimer() {
            const bar = document.getElementById('timerBar');
            bar.classList.remove('timer-animate');
            void bar.offsetWidth; 
            bar.classList.add('timer-animate');
            clearTimeout(timerInterval);
            timerInterval = setTimeout(() => handleTimeout(), TIME_LIMIT * 1000);
        }

        function handleTimeout() { makeChoice({ text: "(No Decision Made)", score: 0 }, null); }

        async function makeChoice(option, btnElement) {
            clearTimeout(timerInterval);
            document.getElementById('timerBar').classList.remove('timer-animate');
            if(btnElement) {
                const allBtns = document.querySelectorAll('.choice-btn');
                allBtns.forEach(b => b.classList.add('opacity-50', 'pointer-events-none'));
                btnElement.classList.remove('opacity-50');
                btnElement.classList.add('ring-2', 'ring-blue-600', 'bg-blue-50');
            }
            document.getElementById('choicesContainer').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('hidden');

            const idx = selectedIndices[currentPlayIndex];
            const topic = topics[idx];
            const feedback = await getAIFeedback(activeScenario, option.text, topic.principle);
            
            totalScore += option.score;
            updateScoreUI();
            showResultModal(feedback, option.score);
        }

        function updateScoreUI() {
            const max = (currentPlayIndex + 1) * 10;
            const pct = Math.round((totalScore / max) * 100) || 100;
            document.getElementById('iqText').innerText = pct + "%";
            document.getElementById('iqText').className = pct < 50 ? "text-red-500 font-bold" : (pct < 80 ? "text-yellow-600 font-bold" : "text-green-600 font-bold");
        }

        function showResultModal(feedbackText, score) {
            const qContainer = document.getElementById('questionTextContainer');
            qContainer.style.opacity = '0';
            setTimeout(() => {
                let title = score === 10 ? "Excellent" : (score === 7 ? "Good" : (score === 3 ? "Weak" : "Critical Failure"));
                let color = score >= 7 ? "text-green-600" : "text-red-600";
                qContainer.innerHTML = `<h2 class="text-3xl font-extrabold ${color} mb-4">${title} (+${score})</h2><p class="text-lg text-slate-700 leading-relaxed italic border-l-4 border-slate-200 pl-4">"${feedbackText}"</p><button onclick="nextLevel()" class="mt-8 bg-slate-900 text-white font-bold py-3 px-8 rounded-lg hover:bg-slate-800 transition shadow-lg">Next</button>`;
                qContainer.style.opacity = '1';
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 500);
        }

        function nextLevel() {
            currentPlayIndex++;
            if (currentPlayIndex < 5) {
                document.getElementById('questionTextContainer').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('questionTextContainer').innerHTML = `<h2 class="text-2xl lg:text-3xl font-extrabold text-slate-800 leading-tight mb-4" id="scenarioTitle">Title</h2><p class="text-lg text-slate-600 leading-relaxed max-w-3xl mx-auto" id="scenarioText">Loading...</p>`;
                    document.getElementById('choicesContainer').classList.remove('hidden');
                    document.getElementById('choicesContainer').style.opacity = '0';
                    startRound();
                }, 500);
            } else {
                endGame();
            }
        }

        function endGame() {
            const max = 50; const pct = Math.round((totalScore / max) * 100); const isWin = pct >= 80;
            document.getElementById('contentColumn').innerHTML = `<div class="glass-panel rounded-2xl p-10 flex flex-col items-center justify-center h-full text-center fade-enter-active"><div class="w-24 h-24 rounded-full ${isWin ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} flex items-center justify-center text-4xl mb-6"><i class="fas ${isWin ? 'fa-trophy' : 'fa-times'}"></i></div><h1 class="text-4xl font-extrabold text-slate-900 mb-2">${isWin ? 'Contract Renewed' : 'Terminated'}</h1><p class="text-xl text-slate-500 mb-8">Final Score: ${pct}%</p><p class="max-w-xl text-slate-600 text-lg leading-relaxed mb-8">${isWin ? "The Board is impressed by your strategic parenting advantage." : "Your decisions lacked strategic coherence. The Board has lost confidence."}</p><button onclick="location.reload()" class="bg-blue-600 text-white font-bold py-4 px-10 rounded-xl hover:bg-blue-700 transition shadow-xl">Play Again</button></div>`;
        }

        async function getAIFeedback(scenarioData, userChoice, principle) {
            const prompt = `Role: Board Chairman. Scenario: ${scenarioData.text} Correct Principle: ${principle} User chose: "${userChoice}" Task: Provide a 1-sentence reaction. If score 10, praise. If 7, explain missing nuance. If <7, critique.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "The Board acknowledges your decision."; }
        }
    </script>
</body>
</html>
